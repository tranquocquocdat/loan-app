<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <title>Chi tiáº¿t há»“ sÆ¡ #[[${app.id}]] - [[${section == 'intake' ? 'PhÃ²ng tiáº¿p nháº­n' : (section == 'assessment' ? 'PhÃ²ng tháº©m Ä‘á»‹nh' : 'PhÃ²ng giáº£i ngÃ¢n')}]]</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .status-timeline {
            margin: 20px 0;
            padding: 16px;
            background: #0f172a;
            border-radius: 12px;
            border: 1px solid #374151;
        }
        .timeline-step {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .timeline-step.completed {
            background: rgba(34, 197, 94, 0.1);
            border-left: 3px solid #22c55e;
        }
        .timeline-step.current {
            background: rgba(34, 211, 238, 0.1);
            border-left: 3px solid #22d3ee;
            animation: pulse 2s infinite;
        }
        .timeline-step.rejected {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
        }
        .timeline-icon {
            margin-right: 12px;
            font-size: 1.2em;
        }
        .timeline-content {
            flex: 1;
        }
        .timeline-time {
            font-size: 0.8em;
            opacity: 0.7;
            margin-top: 4px;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .action-section {
            margin: 20px 0;
            padding: 16px;
            background: #111827;
            border-radius: 12px;
            border: 1px solid #374151;
        }
        .form-group {
            margin: 12px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #4b5563;
            background: #1f2937;
            color: #e5e7eb;
        }
        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 12px 0;
        }
        .warning-box {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
            color: #fbbf24;
        }
        .info-box {
            background: rgba(34, 211, 238, 0.1);
            border: 1px solid #22d3ee;
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
            color: #22d3ee;
        }
        .customer-info, .loan-info {
            background: #1f2937;
            border-radius: 8px;
            padding: 16px;
            margin: 12px 0;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 4px 0;
            border-bottom: 1px solid #374151;
        }
        .info-label {
            font-weight: 500;
            color: #9ca3af;
        }
        .info-value {
            color: #e5e7eb;
            font-weight: 600;
        }
    </style>
</head>
<body>
<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <div>
            <h1 th:text="${section == 'intake' ? 'ğŸ“¥ PhÃ²ng Tiáº¿p Nháº­n' : (section == 'assessment' ? 'ğŸ” PhÃ²ng Tháº©m Äá»‹nh TÃ­n Dá»¥ng' : 'ğŸ’° PhÃ²ng Giáº£i NgÃ¢n')}">PhÃ²ng</h1>
            <div style="opacity: 0.7; margin-top: -8px;">Há»“ sÆ¡ #<span th:text="${app.id}"></span></div>
        </div>
        <span class="badge" th:text="${app.status}" th:class="'badge ' + ${app.status.name()}"></span>
    </div>

    <nav class="tabs">
        <a th:if="${userRole == 'ADMIN'}" class="tab" href="/admin/dashboard">Dashboard</a>
        <a th:if="${userRole == 'ADMIN' or userRole == 'INTAKE'}" class="tab" href="/admin/intake" th:class="${section=='intake'} ? 'tab active' : 'tab'">PhÃ²ng tiáº¿p nháº­n</a>
        <a th:if="${userRole == 'ADMIN' or userRole == 'ASSESSMENT'}" class="tab" href="/admin/assessment" th:class="${section=='assessment'} ? 'tab active' : 'tab'">PhÃ²ng tháº©m Ä‘á»‹nh</a>
        <a th:if="${userRole == 'ADMIN' or userRole == 'DISBURSEMENT'}" class="tab" href="/admin/disbursement" th:class="${section=='disbursement'} ? 'tab active' : 'tab'">PhÃ²ng giáº£i ngÃ¢n</a>
    </nav>

    <!-- Role info -->
    <div style="background: #0f172a; padding: 8px 16px; border-radius: 6px; margin: 8px 0; display: flex; justify-content: space-between; align-items: center;">
        <div style="font-size: 0.9em;">
            <span style="opacity: 0.7;">ÄÄƒng nháº­p vá»›i quyá»n:</span>
            <span th:if="${userRole == 'ADMIN'}" style="color: #ef4444; font-weight: bold;">ğŸ‘‘ Quáº£n trá»‹ viÃªn</span>
            <span th:if="${userRole == 'INTAKE'}" style="color: #22d3ee; font-weight: bold;">ğŸ“¥ NhÃ¢n viÃªn tiáº¿p nháº­n</span>
            <span th:if="${userRole == 'ASSESSMENT'}" style="color: #a855f7; font-weight: bold;">ğŸ” NhÃ¢n viÃªn tháº©m Ä‘á»‹nh</span>
            <span th:if="${userRole == 'DISBURSEMENT'}" style="color: #22c55e; font-weight: bold;">ğŸ’° NhÃ¢n viÃªn giáº£i ngÃ¢n</span>
        </div>
        <a href="/logout" style="color: #9ca3af; font-size: 0.9em; text-decoration: none;">ÄÄƒng xuáº¥t</a>
    </div>

    <!-- Timeline tráº¡ng thÃ¡i -->
    <div class="status-timeline">
        <h3>ğŸ“‹ Tiáº¿n trÃ¬nh xá»­ lÃ½</h3>

        <div class="timeline-step completed">
            <div class="timeline-icon">ğŸ“</div>
            <div class="timeline-content">
                <strong>Ná»™p há»“ sÆ¡</strong>
                <div class="timeline-time" th:text="${#temporals.format(app.submittedAt, 'dd/MM/yyyy HH:mm')}"></div>
            </div>
        </div>

        <div th:class="'timeline-step ' + (${app.status.name() == 'SUBMITTED'} ? 'current' : (${app.reviewedAt != null} ? 'completed' : ''))">
            <div class="timeline-icon">ğŸ“‹</div>
            <div class="timeline-content">
                <strong>Tiáº¿p nháº­n há»“ sÆ¡</strong>
                <div class="timeline-time" th:if="${app.reviewedAt}"
                     th:text="${#temporals.format(app.reviewedAt, 'dd/MM/yyyy HH:mm')}"></div>
            </div>
        </div>

        <div th:class="'timeline-step ' + (${app.status.name() == 'UNDER_REVIEW'} ? 'current' : (${app.assessedAt != null} ? 'completed' : ''))">
            <div class="timeline-icon">ğŸ”</div>
            <div class="timeline-content">
                <strong>Tháº©m Ä‘á»‹nh tÃ­n dá»¥ng</strong>
                <div class="timeline-time" th:if="${app.assessedAt}"
                     th:text="${#temporals.format(app.assessedAt, 'dd/MM/yyyy HH:mm')}"></div>
            </div>
        </div>

        <div th:class="'timeline-step ' + (${app.status.name() == 'ASSESSED'} ? 'current' : (${app.approvedAt != null} ? 'completed' : (${app.rejectedAt != null} ? 'rejected' : '')))">
            <div class="timeline-icon" th:text="${app.status.name() == 'REJECTED'} ? 'âŒ' : 'âš–ï¸'"></div>
            <div class="timeline-content">
                <strong>Quyáº¿t Ä‘á»‹nh phÃª duyá»‡t</strong>
                <div class="timeline-time" th:if="${app.approvedAt}"
                     th:text="${#temporals.format(app.approvedAt, 'dd/MM/yyyy HH:mm')}"></div>
                <div class="timeline-time" th:if="${app.rejectedAt}"
                     th:text="${#temporals.format(app.rejectedAt, 'dd/MM/yyyy HH:mm')}"></div>
            </div>
        </div>

        <div th:if="${app.status.name() != 'REJECTED'}"
             th:class="'timeline-step ' + (${app.status.name() == 'APPROVED'} ? 'current' : (${app.disbursedAt != null} ? 'completed' : ''))">
            <div class="timeline-icon">ğŸ’°</div>
            <div class="timeline-content">
                <strong>Giáº£i ngÃ¢n</strong>
                <div class="timeline-time" th:if="${app.disbursedAt}"
                     th:text="${#temporals.format(app.disbursedAt, 'dd/MM/yyyy HH:mm')}"></div>
            </div>
        </div>
    </div>

    <!-- ThÃ´ng bÃ¡o -->
    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

    <!-- ThÃ´ng tin há»“ sÆ¡ -->
    <div class="grid2">
        <div class="customer-info">
            <h3>ğŸ‘¤ ThÃ´ng tin khÃ¡ch hÃ ng</h3>
            <div class="info-row">
                <span class="info-label">Há» tÃªn:</span>
                <span class="info-value" th:text="${app.customer.fullName}"></span>
            </div>
            <div class="info-row">
                <span class="info-label">Email:</span>
                <span class="info-value" th:text="${app.customer.email}"></span>
            </div>
            <div class="info-row">
                <span class="info-label">Äiá»‡n thoáº¡i:</span>
                <span class="info-value" th:text="${app.customer.phone}"></span>
            </div>
        </div>

        <div class="loan-info">
            <h3>ğŸ’° Chi tiáº¿t khoáº£n vay</h3>
            <div class="info-row">
                <span class="info-label">Sá»‘ tiá»n:</span>
                <span class="info-value" th:text="${#numbers.formatInteger(app.amount,3,'POINT')} + ' VND'"></span>
            </div>
            <div class="info-row">
                <span class="info-label">Ká»³ háº¡n:</span>
                <span class="info-value" th:text="${app.termMonths} + ' thÃ¡ng'"></span>
            </div>
            <div class="info-row">
                <span class="info-label">Má»¥c Ä‘Ã­ch:</span>
                <span class="info-value" th:text="${app.purpose != null ? app.purpose : 'KhÃ´ng cÃ³'}"></span>
            </div>
            <div class="info-row">
                <span class="info-label">Thu nháº­p/thÃ¡ng:</span>
                <span class="info-value" th:text="${#numbers.formatInteger(app.monthlyIncome,3,'POINT')} + ' VND'"></span>
            </div>
        </div>
    </div>

    <!-- Ghi chÃº vÃ  thÃ´ng tin bá»• sung -->
    <div th:if="${app.assessmentNote != null or app.approvalNote != null or app.rejectionReason != null}">
        <div class="customer-info">
            <h3>ğŸ“ Ghi chÃº xá»­ lÃ½</h3>
            <div th:if="${app.assessmentNote != null}" class="info-row">
                <span class="info-label">Ghi chÃº tháº©m Ä‘á»‹nh:</span>
                <span class="info-value" th:text="${app.assessmentNote}"></span>
            </div>
            <div th:if="${app.approvalNote != null}" class="info-row">
                <span class="info-label">Ghi chÃº phÃª duyá»‡t:</span>
                <span class="info-value" th:text="${app.approvalNote}"></span>
            </div>
            <div th:if="${app.rejectionReason != null}" class="info-row">
                <span class="info-label">LÃ½ do tá»« chá»‘i:</span>
                <span class="info-value" style="color: #ef4444;" th:text="${app.rejectionReason}"></span>
            </div>
        </div>
    </div>

    <!-- Thao tÃ¡c theo phÃ²ng -->
    <div class="action-section">
        <h3>ğŸ¯ <span th:text="${section == 'intake' ? 'PhÃ²ng Tiáº¿p Nháº­n' : (section == 'assessment' ? 'PhÃ²ng Tháº©m Äá»‹nh TÃ­n Dá»¥ng' : 'PhÃ²ng Giáº£i NgÃ¢n')}"></span></h3>

        <!-- PHÃ’NG TIáº¾P NHáº¬N -->
        <div th:if="${section=='intake'}">
            <div th:if="${!canAccept and app.status.name()=='SUBMITTED'}" class="warning-box">
                âš ï¸ Há»“ sÆ¡ chÆ°a Ä‘áº§y Ä‘á»§ thÃ´ng tin. Cáº§n bá»• sung cÃ¡c trÆ°á»ng báº¯t buá»™c trÆ°á»›c khi tiáº¿p nháº­n.
            </div>

            <form th:if="${app.status.name()=='SUBMITTED'}"
                  th:action="@{'/admin/' + ${app.id} + '/intake/accept'}" method="post">
                <input type="hidden" name="redirectTo" th:value="@{'/admin/intake/app/' + ${app.id}}"/>
                <button class="btn btn-primary" th:disabled="${!canAccept}" type="submit">
                    ğŸ“‹ Tiáº¿p nháº­n há»“ sÆ¡ (chuyá»ƒn sang phÃ²ng tháº©m Ä‘á»‹nh)
                </button>
            </form>

            <div th:if="${app.status.name() != 'SUBMITTED'}" class="info-box">
                âœ… Há»“ sÆ¡ Ä‘Ã£ Ä‘Æ°á»£c tiáº¿p nháº­n vÃ  chuyá»ƒn qua phÃ²ng tháº©m Ä‘á»‹nh.
                <div style="margin-top: 8px;">
                    <a class="btn btn-outline" th:href="@{'/admin/assessment/app/' + ${app.id}}">
                        ğŸ” Xem táº¡i phÃ²ng tháº©m Ä‘á»‹nh
                    </a>
                </div>
            </div>
        </div>

        <!-- PHÃ’NG THáº¨M Äá»ŠNH -->
        <div th:if="${section=='assessment'}">
            <div th:if="${app.status.name()=='UNDER_REVIEW'}">
                <div class="info-box">
                    ğŸ” Há»“ sÆ¡ Ä‘ang trong quÃ¡ trÃ¬nh tháº©m Ä‘á»‹nh. Vui lÃ²ng thá»±c hiá»‡n cÃ¡c bÆ°á»›c sau:
                </div>

                <form th:action="@{'/admin/' + ${app.id} + '/assessment/check-blacklist'}" method="post" style="margin: 12px 0;">
                    <input type="hidden" name="redirectTo" th:value="@{'/admin/assessment/app/' + ${app.id}}"/>
                    <button class="btn btn-warning" type="submit">ğŸš¨ Kiá»ƒm tra Blacklist</button>
                </form>

                <form th:action="@{'/admin/' + ${app.id} + '/assessment/complete'}" method="post">
                    <div class="form-group">
                        <label>Ghi chÃº tháº©m Ä‘á»‹nh:</label>
                        <textarea name="note" rows="3" placeholder="Nháº­p káº¿t quáº£ tháº©m Ä‘á»‹nh vÃ  Ä‘Ã¡nh giÃ¡..."></textarea>
                    </div>
                    <input type="hidden" name="redirectTo" th:value="@{'/admin/assessment/app/' + ${app.id}}"/>
                    <button class="btn btn-primary" type="submit">âœ… HoÃ n táº¥t tháº©m Ä‘á»‹nh</button>
                </form>
            </div>

            <div th:if="${app.status.name()=='ASSESSED'}">
                <div class="info-box">
                    âš–ï¸ Há»“ sÆ¡ Ä‘Ã£ hoÃ n táº¥t tháº©m Ä‘á»‹nh. Vui lÃ²ng Ä‘Æ°a ra quyáº¿t Ä‘á»‹nh:
                </div>

                <form th:action="@{'/admin/' + ${app.id} + '/approve'}" method="post" style="margin: 12px 0;">
                    <div class="form-group">
                        <input name="note" placeholder="Ghi chÃº phÃª duyá»‡t (tÃ¹y chá»n)" style="width: 300px;"/>
                    </div>
                    <input type="hidden" name="redirectTo" th:value="@{'/admin/assessment/app/' + ${app.id}}"/>
                    <button class="btn btn-success" type="submit">âœ… PhÃª duyá»‡t (chuyá»ƒn sang phÃ²ng giáº£i ngÃ¢n)</button>
                </form>

                <form th:action="@{'/admin/' + ${app.id} + '/reject'}" method="post" style="margin-top: 12px;">
                    <div class="form-group">
                        <label>LÃ½ do tá»« chá»‘i:</label>
                        <textarea name="reason" rows="2" placeholder="Nháº­p lÃ½ do tá»« chá»‘i..." required></textarea>
                    </div>
                    <input type="hidden" name="redirectTo" th:value="@{'/admin/assessment/app/' + ${app.id}}"/>
                    <button class="btn btn-danger" type="submit">âŒ Tá»« chá»‘i</button>
                </form>
            </div>

            <div th:if="${app.status.name() == 'REJECTED'}" class="warning-box">
                âŒ Há»“ sÆ¡ Ä‘Ã£ bá»‹ tá»« chá»‘i. KhÃ´ng thá»ƒ thá»±c hiá»‡n thÃªm thao tÃ¡c.
            </div>

            <div th:if="${app.status.name() == 'APPROVED'}" class="info-box">
                âœ… Há»“ sÆ¡ Ä‘Ã£ Ä‘Æ°á»£c phÃª duyá»‡t vÃ  chuyá»ƒn qua phÃ²ng giáº£i ngÃ¢n.
                <div style="margin-top: 8px;">
                    <a class="btn btn-outline" th:href="@{'/admin/disbursement/app/' + ${app.id}}">
                        ğŸ’° Xem táº¡i phÃ²ng giáº£i ngÃ¢n
                    </a>
                </div>
            </div>
        </div>

        <!-- PHÃ’NG GIáº¢I NGÃ‚N -->
        <div th:if="${section=='disbursement'}">
            <div th:if="${app.status.name()=='APPROVED'}">
                <div class="info-box">
                    ğŸ’° Há»“ sÆ¡ Ä‘Ã£ Ä‘Æ°á»£c phÃª duyá»‡t vÃ  sáºµn sÃ ng giáº£i ngÃ¢n.
                </div>

                <form th:action="@{'/admin/' + ${app.id} + '/disburse'}" method="post">
                    <input type="hidden" name="redirectTo" th:value="@{'/admin/disbursement/app/' + ${app.id}}"/>
                    <button class="btn btn-warning" type="submit">ğŸ’° Thá»±c hiá»‡n giáº£i ngÃ¢n</button>
                </form>
            </div>

            <div th:if="${app.status.name()=='DISBURSED'}" class="info-box">
                âœ… Há»“ sÆ¡ Ä‘Ã£ Ä‘Æ°á»£c giáº£i ngÃ¢n thÃ nh cÃ´ng! Quy trÃ¬nh hoÃ n táº¥t.
            </div>

            <div th:if="${app.status.name()=='APPROVED' or app.status.name()=='DISBURSED'}" style="margin-top: 16px;">
                <a class="btn btn-outline" th:href="@{'/admin/' + ${app.id} + '/contract'}">ğŸ“„ Xem há»£p Ä‘á»“ng</a>
                <a class="btn btn-outline" th:href="@{'/status/' + ${app.id}}">ğŸ‘ï¸ Xem nhÆ° khÃ¡ch hÃ ng</a>
            </div>

            <!-- KhÃ´ng cÃ³ nÃºt chuyá»ƒn phÃ²ng vÃ¬ Ä‘Ã¢y lÃ  phÃ²ng cuá»‘i cÃ¹ng -->
        </div>
    </div>

    <!-- Navigation -->
    <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #374151; display: flex; justify-content: space-between; align-items: center;">
        <div>
            <a class="link" th:href="@{'/admin/' + ${section}}">â† Quay láº¡i danh sÃ¡ch</a>
            <span style="margin: 0 16px;">â€¢</span>
            <a class="link" href="/admin/dashboard">ğŸ  Dashboard</a>
        </div>

        <!-- Navigation buttons between departments -->
        <div style="display: flex; gap: 8px;">
            <!-- PhÃ²ng tiáº¿p nháº­n -> PhÃ²ng tháº©m Ä‘á»‹nh -->
            <a th:if="${section == 'intake' and (app.status.name() == 'UNDER_REVIEW' or app.status.name() == 'ASSESSED' or app.status.name() == 'APPROVED' or app.status.name() == 'DISBURSED')}"
               class="btn btn-outline"
               th:href="@{'/admin/assessment/app/' + ${app.id}}">
                ğŸ” Äáº¿n phÃ²ng tháº©m Ä‘á»‹nh
            </a>

            <!-- PhÃ²ng tháº©m Ä‘á»‹nh -> PhÃ²ng giáº£i ngÃ¢n -->
            <a th:if="${section == 'assessment' and (app.status.name() == 'APPROVED' or app.status.name() == 'DISBURSED')}"
               class="btn btn-outline"
               th:href="@{'/admin/disbursement/app/' + ${app.id}}">
                ğŸ’° Äáº¿n phÃ²ng giáº£i ngÃ¢n
            </a>
        </div>
    </div>
</div>

<script>
// Auto refresh every 30 seconds for status updates
setTimeout(() => {
    if (document.querySelector('.timeline-step.current')) {
        location.reload();
    }
}, 30000);
</script>
</body>
</html>