<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <title>Chi ti·∫øt h·ªì s∆° #[[${app.id}]] - [[${section == 'intake' ? 'Ph√≤ng ti·∫øp nh·∫≠n' : (section == 'assessment' ? 'Ph√≤ng th·∫©m ƒë·ªãnh' : 'Ph√≤ng gi·∫£i ng√¢n')}]]</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .status-timeline {
            margin: 20px 0;
            padding: 16px;
            background: #0f172a;
            border-radius: 12px;
            border: 1px solid #374151;
        }
        .timeline-step {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .timeline-step.completed {
            background: rgba(34, 197, 94, 0.1);
            border-left: 3px solid #22c55e;
        }
        .timeline-step.current {
            background: rgba(34, 211, 238, 0.1);
            border-left: 3px solid #22d3ee;
            animation: pulse 2s infinite;
        }
        .timeline-step.rejected {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
        }
        .timeline-icon {
            margin-right: 12px;
            font-size: 1.2em;
        }
        .timeline-content {
            flex: 1;
        }
        .timeline-time {
            font-size: 0.8em;
            opacity: 0.7;
            margin-top: 4px;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .action-section {
            margin: 20px 0;
            padding: 16px;
            background: #111827;
            border-radius: 12px;
            border: 1px solid #374151;
        }
        .form-group {
            margin: 12px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #4b5563;
            background: #1f2937;
            color: #e5e7eb;
        }
        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 12px 0;
        }
        .warning-box {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
            color: #fbbf24;
        }
        .info-box {
            background: rgba(34, 211, 238, 0.1);
            border: 1px solid #22d3ee;
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
            color: #22d3ee;
        }
        .customer-info, .loan-info {
            background: #1f2937;
            border-radius: 8px;
            padding: 16px;
            margin: 12px 0;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 4px 0;
            border-bottom: 1px solid #374151;
        }
        .info-label {
            font-weight: 500;
            color: #9ca3af;
        }
        .info-value {
            color: #e5e7eb;
            font-weight: 600;
        }
    </style>
</head>
<body>
<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <div>
            <h1 th:text="${section == 'intake' ? 'üì• Ph√≤ng Ti·∫øp Nh·∫≠n' : (section == 'assessment' ? 'üîç Ph√≤ng Th·∫©m ƒê·ªãnh T√≠n D·ª•ng' : 'üí∞ Ph√≤ng Gi·∫£i Ng√¢n')}">Ph√≤ng</h1>
            <div style="opacity: 0.7; margin-top: -8px;">H·ªì s∆° #<span th:text="${app.id}"></span></div>
        </div>
        <span class="badge" th:text="${app.status}" th:class="'badge ' + ${app.status.name()}"></span>
    </div>

    <nav class="tabs">
        <a th:if="${userRole == 'ADMIN'}" class="tab" href="/admin/dashboard">Dashboard</a>
        <a th:if="${userRole == 'ADMIN' or userRole == 'INTAKE'}" class="tab" href="/admin/intake" th:class="${section=='intake'} ? 'tab active' : 'tab'">Ph√≤ng ti·∫øp nh·∫≠n</a>
        <a th:if="${userRole == 'ADMIN' or userRole == 'ASSESSMENT'}" class="tab" href="/admin/assessment" th:class="${section=='assessment'} ? 'tab active' : 'tab'">Ph√≤ng th·∫©m ƒë·ªãnh</a>
        <a th:if="${userRole == 'ADMIN' or userRole == 'DISBURSEMENT'}" class="tab" href="/admin/disbursement" th:class="${section=='disbursement'} ? 'tab active' : 'tab'">Ph√≤ng gi·∫£i ng√¢n</a>
    </nav>

    <!-- Role info -->
    <div style="background: #0f172a; padding: 8px 16px; border-radius: 6px; margin: 8px 0; display: flex; justify-content: space-between; align-items: center;">
        <div style="font-size: 0.9em;">
            <span style="opacity: 0.7;">ƒêƒÉng nh·∫≠p v·ªõi quy·ªÅn:</span>
            <span th:if="${userRole == 'ADMIN'}" style="color: #ef4444; font-weight: bold;">üëë Qu·∫£n tr·ªã vi√™n</span>
            <span th:if="${userRole == 'INTAKE'}" style="color: #22d3ee; font-weight: bold;">üì• Nh√¢n vi√™n ti·∫øp nh·∫≠n</span>
            <span th:if="${userRole == 'ASSESSMENT'}" style="color: #a855f7; font-weight: bold;">üîç Nh√¢n vi√™n th·∫©m ƒë·ªãnh</span>
            <span th:if="${userRole == 'DISBURSEMENT'}" style="color: #22c55e; font-weight: bold;">üí∞ Nh√¢n vi√™n gi·∫£i ng√¢n</span>
        </div>
        <a href="/logout" style="color: #9ca3af; font-size: 0.9em; text-decoration: none;">ƒêƒÉng xu·∫•t</a>
    </div>

    <!-- Timeline tr·∫°ng th√°i -->
    <div class="status-timeline">
        <h3>üìã Ti·∫øn tr√¨nh x·ª≠ l√Ω</h3>

        <div class="timeline-step completed">
            <div class="timeline-icon">üìù</div>
            <div class="timeline-content">
                <strong>N·ªôp h·ªì s∆°</strong>
                <div class="timeline-time" th:text="${#temporals.format(app.submittedAt, 'dd/MM/yyyy HH:mm')}"></div>
            </div>
        </div>

        <div th:class="'timeline-step ' + (${app.status.name() == 'SUBMITTED'} ? 'current' : (${app.reviewedAt != null} ? 'completed' : ''))">
            <div class="timeline-icon">üìã</div>
            <div class="timeline-content">
                <strong>Ti·∫øp nh·∫≠n h·ªì s∆°</strong>
                <div class="timeline-time" th:if="${app.reviewedAt}"
                     th:text="${#temporals.format(app.reviewedAt, 'dd/MM/yyyy HH:mm')}"></div>
            </div>
        </div>

        <div th:class="'timeline-step ' + (${app.status.name() == 'UNDER_REVIEW'} ? 'current' : (${app.assessedAt != null} ? 'completed' : ''))">
            <div class="timeline-icon">üîç</div>
            <div class="timeline-content">
                <strong>Th·∫©m ƒë·ªãnh t√≠n d·ª•ng</strong>
                <div class="timeline-time" th:if="${app.assessedAt}"
                     th:text="${#temporals.format(app.assessedAt, 'dd/MM/yyyy HH:mm')}"></div>
            </div>
        </div>

        <div th:class="'timeline-step ' + (${app.status.name() == 'ASSESSED'} ? 'current' : (${app.approvedAt != null} ? 'completed' : (${app.rejectedAt != null} ? 'rejected' : '')))">
            <div class="timeline-icon" th:text="${app.status.name() == 'REJECTED'} ? '‚ùå' : '‚öñÔ∏è'"></div>
            <div class="timeline-content">
                <strong>Quy·∫øt ƒë·ªãnh ph√™ duy·ªát</strong>
                <div class="timeline-time" th:if="${app.approvedAt}"
                     th:text="${#temporals.format(app.approvedAt, 'dd/MM/yyyy HH:mm')}"></div>
                <div class="timeline-time" th:if="${app.rejectedAt}"
                     th:text="${#temporals.format(app.rejectedAt, 'dd/MM/yyyy HH:mm')}"></div>
            </div>
        </div>

        <div th:if="${app.status.name() != 'REJECTED'}"
             th:class="'timeline-step ' + (${app.status.name() == 'APPROVED'} ? 'current' : (${app.disbursedAt != null} ? 'completed' : ''))">
            <div class="timeline-icon">üí∞</div>
            <div class="timeline-content">
                <strong>Gi·∫£i ng√¢n</strong>
                <div class="timeline-time" th:if="${app.disbursedAt}"
                     th:text="${#temporals.format(app.disbursedAt, 'dd/MM/yyyy HH:mm')}"></div>
            </div>
        </div>
    </div>

    <!-- Th√¥ng b√°o -->
    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

    <!-- Th√¥ng tin h·ªì s∆° -->
    <div class="grid2">
        <div class="customer-info">
            <h3>üë§ Th√¥ng tin kh√°ch h√†ng</h3>
            <div class="info-row">
                <span class="info-label">H·ªç t√™n:</span>
                <span class="info-value" th:text="${app.customer.fullName}"></span>
            </div>
            <div class="info-row">
                <span class="info-label">Email:</span>
                <span class="info-value" th:text="${app.customer.email}"></span>
            </div>
            <div class="info-row">
                <span class="info-label">ƒêi·ªán tho·∫°i:</span>
                <span class="info-value" th:text="${app.customer.phone}"></span>
            </div>
        </div>

        <div class="loan-info">
            <h3>üí∞ Chi ti·∫øt kho·∫£n vay</h3>
            <div class="info-row">
                <span class="info-label">S·ªë ti·ªÅn:</span>
                <span class="info-value" th:text="${#numbers.formatInteger(app.amount,3,'POINT')} + ' VND'"></span>
            </div>
            <div class="info-row">
                <span class="info-label">K·ª≥ h·∫°n:</span>
                <span class="info-value" th:text="${app.termMonths} + ' th√°ng'"></span>
            </div>
            <div class="info-row">
                <span class="info-label">M·ª•c ƒë√≠ch:</span>
                <span class="info-value" th:text="${app.purpose != null ? app.purpose : 'Kh√¥ng c√≥'}"></span>
            </div>
            <div class="info-row">
                <span class="info-label">Thu nh·∫≠p/th√°ng:</span>
                <span class="info-value" th:text="${#numbers.formatInteger(app.monthlyIncome,3,'POINT')} + ' VND'"></span>
            </div>
        </div>
    </div>

    <!-- Ghi ch√∫ v√† th√¥ng tin b·ªï sung -->
    <div th:if="${app.assessmentNote != null or app.approvalNote != null or app.rejectionReason != null}">
        <div class="customer-info">
            <h3>üìù Ghi ch√∫ x·ª≠ l√Ω</h3>
            <div th:if="${app.assessmentNote != null}" class="info-row">
                <span class="info-label">Ghi ch√∫ th·∫©m ƒë·ªãnh:</span>
                <span class="info-value" th:text="${app.assessmentNote}"></span>
            </div>
            <div th:if="${app.approvalNote != null}" class="info-row">
                <span class="info-label">Ghi ch√∫ ph√™ duy·ªát:</span>
                <span class="info-value" th:text="${app.approvalNote}"></span>
            </div>
            <div th:if="${app.rejectionReason != null}" class="info-row">
                <span class="info-label">L√Ω do t·ª´ ch·ªëi:</span>
                <span class="info-value" style="color: #ef4444;" th:text="${app.rejectionReason}"></span>
            </div>
        </div>
    </div>

    <!-- Thao t√°c theo ph√≤ng -->
    <div class="action-section">
        <h3>üéØ <span th:text="${section == 'intake' ? 'Ph√≤ng Ti·∫øp Nh·∫≠n' : (section == 'assessment' ? 'Ph√≤ng Th·∫©m ƒê·ªãnh T√≠n D·ª•ng' : 'Ph√≤ng Gi·∫£i Ng√¢n')}"></span></h3>

        <!-- PH√íNG TI·∫æP NH·∫¨N -->
        <div th:if="${section=='intake'}">
            <div th:if="${!canAccept and app.status.name()=='SUBMITTED'}" class="warning-box">
                ‚ö†Ô∏è H·ªì s∆° ch∆∞a ƒë·∫ßy ƒë·ªß th√¥ng tin. C·∫ßn b·ªï sung c√°c tr∆∞·ªùng b·∫Øt bu·ªôc tr∆∞·ªõc khi ti·∫øp nh·∫≠n.
            </div>

            <form th:if="${app.status.name()=='SUBMITTED'}"
                  th:action="@{'/admin/' + ${app.id} + '/intake/accept'}" method="post">
                <input type="hidden" name="redirectTo" th:value="@{'/admin/intake/app/' + ${app.id}}"/>
                <button class="btn btn-primary" th:disabled="${!canAccept}" type="submit">
                    üìã Ti·∫øp nh·∫≠n h·ªì s∆° (chuy·ªÉn sang ph√≤ng th·∫©m ƒë·ªãnh)
                </button>
            </form>

            <div th:if="${app.status.name() != 'SUBMITTED'}" class="info-box">
                ‚úÖ H·ªì s∆° ƒë√£ ƒë∆∞·ª£c ti·∫øp nh·∫≠n v√† chuy·ªÉn qua ph√≤ng th·∫©m ƒë·ªãnh.
                <div style="margin-top: 8px;">
                    <a class="btn btn-outline" th:href="@{'/admin/assessment/app/' + ${app.id}}">
                        üîç Xem t·∫°i ph√≤ng th·∫©m ƒë·ªãnh
                    </a>
                </div>
            </div>
        </div>

        <!-- PH√íNG TH·∫®M ƒê·ªäNH -->
        <div th:if="${section=='assessment'}">
            <div th:if="${app.status.name()=='UNDER_REVIEW'}">
                <div class="info-box">
                    üîç H·ªì s∆° ƒëang trong qu√° tr√¨nh th·∫©m ƒë·ªãnh. Vui l√≤ng th·ª±c hi·ªán c√°c b∆∞·ªõc sau:
                </div>

                <form th:action="@{'/admin/' + ${app.id} + '/assessment/check-blacklist'}" method="post" style="margin: 12px 0;">
                    <input type="hidden" name="redirectTo" th:value="@{'/admin/assessment/app/' + ${app.id}}"/>
                    <button class="btn btn-warning" type="submit">üö® Ki·ªÉm tra Blacklist</button>
                </form>

                <form th:action="@{'/admin/' + ${app.id} + '/assessment/complete'}" method="post">
                    <div class="form-group">
                        <label>Ghi ch√∫ th·∫©m ƒë·ªãnh:</label>
                        <textarea name="note" rows="3" placeholder="Nh·∫≠p k·∫øt qu·∫£ th·∫©m ƒë·ªãnh v√† ƒë√°nh gi√°..."></textarea>
                    </div>
                    <input type="hidden" name="redirectTo" th:value="@{'/admin/assessment/app/' + ${app.id}}"/>
                    <button class="btn btn-primary" type="submit">‚úÖ Ho√†n t·∫•t th·∫©m ƒë·ªãnh</button>
                </form>
            </div>

            <div th:if="${app.status.name()=='ASSESSED'}">
                <div class="info-box">
                    ‚öñÔ∏è H·ªì s∆° ƒë√£ ho√†n t·∫•t th·∫©m ƒë·ªãnh. Vui l√≤ng ƒë∆∞a ra quy·∫øt ƒë·ªãnh:
                </div>

                <form th:action="@{'/admin/' + ${app.id} + '/approve'}" method="post" style="margin: 12px 0;">
                    <div class="form-group">
                        <input name="note" placeholder="Ghi ch√∫ ph√™ duy·ªát (t√πy ch·ªçn)" style="width: 300px;"/>
                    </div>
                    <input type="hidden" name="redirectTo" th:value="@{'/admin/assessment/app/' + ${app.id}}"/>
                    <button class="btn btn-success" type="submit">‚úÖ Ph√™ duy·ªát (chuy·ªÉn sang ph√≤ng gi·∫£i ng√¢n)</button>
                </form>

                <form th:action="@{'/admin/' + ${app.id} + '/reject'}" method="post" style="margin-top: 12px;">
                    <div class="form-group">
                        <label>L√Ω do t·ª´ ch·ªëi:</label>
                        <textarea name="reason" rows="2" placeholder="Nh·∫≠p l√Ω do t·ª´ ch·ªëi..." required></textarea>
                    </div>
                    <input type="hidden" name="redirectTo" th:value="@{'/admin/assessment/app/' + ${app.id}}"/>
                    <button class="btn btn-danger" type="submit">‚ùå T·ª´ ch·ªëi</button>
                </form>
            </div>

            <div th:if="${app.status.name() == 'REJECTED'}" class="warning-box">
                ‚ùå H·ªì s∆° ƒë√£ b·ªã t·ª´ ch·ªëi. Kh√¥ng th·ªÉ th·ª±c hi·ªán th√™m thao t√°c.
            </div>

            <div th:if="${app.status.name() == 'APPROVED'}" class="info-box">
                ‚úÖ H·ªì s∆° ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát v√† chuy·ªÉn qua ph√≤ng gi·∫£i ng√¢n.
                <div style="margin-top: 8px;">
                    <a class="btn btn-outline" th:href="@{'/admin/disbursement/app/' + ${app.id}}">
                        üí∞ Xem t·∫°i ph√≤ng gi·∫£i ng√¢n
                    </a>
                </div>
            </div>
        </div>

        <!-- PH√íNG GI·∫¢I NG√ÇN -->
        <div th:if="${section=='disbursement'}">
            <div th:if="${app.status.name()=='APPROVED'}">
                <div class="info-box">
                    üí∞ H·ªì s∆° ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát v√† s·∫µn s√†ng gi·∫£i ng√¢n.
                </div>

                <form th:action="@{'/admin/' + ${app.id} + '/disburse'}" method="post">
                    <input type="hidden" name="redirectTo" th:value="@{'/admin/disbursement/app/' + ${app.id}}"/>
                    <button class="btn btn-warning" type="submit">üí∞ Th·ª±c hi·ªán gi·∫£i ng√¢n</button>
                </form>
            </div>

            <div th:if="${app.status.name()=='DISBURSED'}" class="info-box">
                ‚úÖ H·ªì s∆° ƒë√£ ƒë∆∞·ª£c gi·∫£i ng√¢n th√†nh c√¥ng! Quy tr√¨nh ho√†n t·∫•t.
            </div>

            <div th:if="${app.status.name()=='APPROVED' or app.status.name()=='DISBURSED'}" style="margin-top: 16px;">
                <a class="btn btn-outline" th:href="@{'/admin/' + ${app.id} + '/contract'}">üìÑ Xem h·ª£p ƒë·ªìng</a>
                <a class="btn btn-outline" th:href="@{'/status/' + ${app.id}}">üëÅÔ∏è Xem nh∆∞ kh√°ch h√†ng</a>
            </div>

            <!-- Kh√¥ng c√≥ n√∫t chuy·ªÉn ph√≤ng v√¨ ƒë√¢y l√† ph√≤ng cu·ªëi c√πng -->
        </div>
    </div>

    <!-- Navigation -->
    <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #374151; display: flex; justify-content: space-between; align-items: center;">
        <div>
            <a class="link" th:href="@{'/admin/' + ${section}}">‚Üê Quay l·∫°i danh s√°ch</a>
            <span style="margin: 0 16px;">‚Ä¢</span>
            <a class="link" href="/admin/dashboard">üè† Dashboard</a>
        </div>

        <!-- Navigation buttons between departments -->
        <div style="display: flex; gap: 8px;">
            <!-- Ph√≤ng ti·∫øp nh·∫≠n -> Ph√≤ng th·∫©m ƒë·ªãnh -->
            <a th:if="${section == 'intake' and (app.status.name() == 'UNDER_REVIEW' or app.status.name() == 'ASSESSED' or app.status.name() == 'APPROVED' or app.status.name() == 'DISBURSED')}"
               class="btn btn-outline"
               th:href="@{'/admin/assessment/app/' + ${app.id}}">
                üîç ƒê·∫øn ph√≤ng th·∫©m ƒë·ªãnh
            </a>

            <!-- Ph√≤ng th·∫©m ƒë·ªãnh -> Ph√≤ng gi·∫£i ng√¢n -->
            <a th:if="${section == 'assessment' and (app.status.name() == 'APPROVED' or app.status.name() == 'DISBURSED')}"
               class="btn btn-outline"
               th:href="@{'/admin/disbursement/app/' + ${app.id}}">
                üí∞ ƒê·∫øn ph√≤ng gi·∫£i ng√¢n
            </a>
        </div>
    </div>
</div>

<script>
// Auto refresh every 30 seconds for status updates
setTimeout(() => {
    if (document.querySelector('.timeline-step.current')) {
        location.reload();
    }
}, 30000);
</script>
</body>
</html>