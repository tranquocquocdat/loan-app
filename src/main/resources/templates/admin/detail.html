<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <title>Chi tiết hồ sơ #[[${app.id}]]</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<div class="container">
    <h1>Hồ sơ #<span th:text="${app.id}"></span> — <span class="badge" th:text="${app.status}"></span></h1>

    <nav class="tabs">
        <a class="tab" href="/admin/intake" th:classappend="${section=='intake'} ? ' active'">Phòng tiếp nhận</a>
        <a class="tab" href="/admin/assessment" th:classappend="${section=='assessment'} ? ' active'">Phòng thẩm định</a>
        <a class="tab" href="/admin/disbursement" th:classappend="${section=='disbursement'} ? ' active'">Phòng giải ngân</a>
    </nav>

    <div class="grid2">
        <div class="card">
            <h3>Thông tin khách hàng</h3>
            <p><b>Họ tên:</b> <span th:text="${app.customer.fullName}"></span></p>
            <p><b>Email:</b> <span th:text="${app.customer.email}"></span></p>
            <p><b>Điện thoại:</b> <span th:text="${app.customer.phone}"></span></p>
        </div>
        <div class="card">
            <h3>Chi tiết khoản vay</h3>
            <p><b>Số tiền:</b> <span th:text="${#numbers.formatInteger(app.amount,3,'POINT')}"></span></p>
            <p><b>Kỳ hạn (tháng):</b> <span th:text="${app.termMonths}"></span></p>
            <p><b>Mục đích:</b> <span th:text="${app.purpose}"></span></p>
            <p><b>Thu nhập/tháng:</b> <span th:text="${#numbers.formatInteger(app.monthlyIncome,3,'POINT')}"></span></p>
        </div>
    </div>

    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

    <h3>Thao tác</h3>
    <div class="actions">

        <!-- PHÒNG TIẾP NHẬN -->
        <div th:if="${section=='intake'}">
            <form th:action="@{'/admin/' + ${app.id} + '/intake/accept'}" method="post">
                <input type="hidden" name="redirectTo" th:value="@{'/admin/intake/app/' + ${app.id}}"/>
                <button class="btn btn-primary"
                        th:disabled="${app.status.name()!='SUBMITTED' or !canAccept}"
                        title="Chỉ khi hồ sơ đầy đủ và ở trạng thái SUBMITTED">Tiếp nhận</button>
            </form>
            <p th:if="${app.status.name()=='SUBMITTED' and !canAccept}" style="opacity:.8;margin-top:6px">
                ⚠️ Hồ sơ chưa đủ trường bắt buộc, vui lòng bổ sung trước khi tiếp nhận.
            </p>
        </div>

        <!-- PHÒNG THẨM ĐỊNH -->
        <div th:if="${section=='assessment'}">
            <form th:if="${app.status.name()=='UNDER_REVIEW'}"
                  th:action="@{'/admin/' + ${app.id} + '/assessment/check-blacklist'}" method="post">
                <input type="hidden" name="redirectTo" th:value="@{'/admin/assessment/app/' + ${app.id}}"/>
                <button class="btn">Check blacklist</button>
            </form>

            <form th:if="${app.status.name()=='UNDER_REVIEW'}"
                  th:action="@{'/admin/' + ${app.id} + '/assessment/complete'}" method="post">
                <input class="input" name="note" placeholder="Ghi chú thẩm định"/>
                <input type="hidden" name="redirectTo" th:value="@{'/admin/assessment/app/' + ${app.id}}"/>
                <button class="btn">Hoàn tất thẩm định</button>
            </form>

            <form th:if="${app.status.name()=='ASSESSED'}"
                  th:action="@{'/admin/' + ${app.id} + '/approve'}" method="post">
                <input class="input" name="note" placeholder="Ghi chú phê duyệt"/>
                <input type="hidden" name="redirectTo" th:value="@{'/admin/assessment/app/' + ${app.id}}"/>
                <button class="btn btn-success">Phê duyệt</button>
            </form>

            <form th:if="${app.status.name()=='UNDER_REVIEW' or app.status.name()=='ASSESSED'}"
                  th:action="@{'/admin/' + ${app.id} + '/reject'}" method="post">
                <input class="input" name="reason" placeholder="Lý do từ chối" required/>
                <input type="hidden" name="redirectTo" th:value="@{'/admin/assessment/app/' + ${app.id}}"/>
                <button class="btn btn-danger">Từ chối</button>
            </form>

            <p th:if="${app.rejectionReason}" style="margin-top:6px">
                <b>Lý do từ chối:</b> <span th:text="${app.rejectionReason}"></span>
            </p>
        </div>

        <!-- PHÒNG GIẢI NGÂN -->
        <div th:if="${section=='disbursement'}">
            <form th:if="${app.status.name()=='APPROVED'}"
                  th:action="@{'/admin/' + ${app.id} + '/disburse'}" method="post">
                <input type="hidden" name="redirectTo" th:value="@{'/admin/disbursement/app/' + ${app.id}}"/>
                <button class="btn btn-warning">Giải ngân</button>
            </form>

            <a class="btn btn-outline"
               th:if="${app.status.name()=='APPROVED' or app.status.name()=='DISBURSED'}"
               th:href="@{'/admin/' + ${app.id} + '/contract'}">Hợp đồng</a>
            <a class="link" th:href="@{'/status/' + ${app.id}}">Xem cho KH</a>
        </div>
    </div>

    <div style="margin-top:16px">
        <a class="link" th:href="@{'/admin/' + ${section}}">← Quay lại danh sách</a>
    </div>
</div>
</body>
</html>
