<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <title>Quản trị hồ sơ</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<div class="container">
  <h1>Quản trị hồ sơ (3 phòng)</h1>

  <nav class="tabs">
    <a class="tab" th:classappend="${section=='intake'} ? ' active'" href="/admin/intake">Phòng tiếp nhận</a>
    <a class="tab" th:classappend="${section=='assessment'} ? ' active'" href="/admin/assessment">Phòng thẩm định</a>
    <a class="tab" th:classappend="${section=='disbursement'} ? ' active'" href="/admin/disbursement">Phòng giải ngân</a>
  </nav>

  <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
  <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

  <table>
    <thead>
    <tr>
      <th>ID</th><th>KH</th><th>Số tiền</th><th>Kỳ hạn</th><th>Trạng thái</th><th>Hành động</th>
    </tr>
    </thead>
    <tbody>
    <tr th:if="${#lists.isEmpty(apps)}">
      <td colspan="6" style="text-align:center;opacity:.7;padding:24px">Không có hồ sơ trong mục này.</td>
    </tr>

    <tr th:each="a : ${apps}">
      <td th:text="${a.id}"></td>
      <td th:text="${a.customer.fullName}"></td>
      <td th:text="${#numbers.formatInteger(a.amount,3,'POINT')}"></td>
      <td th:text="${a.termMonths}"></td>
      <td><span class="badge" th:text="${a.status}"></span></td>
      <td class="actions">
        <!-- 1) Chi tiết -->
        <a class="btn btn-outline"
           th:href="@{'/admin/' + ${section} + '/app/' + ${a.id}}">Chi tiết</a>

        <!-- 2) Chuyển đến phòng kế bên -->
        <form th:action="@{'/admin/' + ${a.id} + '/next'}" method="post" style="display:inline;margin-left:6px">
          <input type="hidden" name="redirectTo" th:value="@{'/admin/' + ${section}}"/>
          <!-- Enable rule theo tab -->
          <button class="btn"
                  th:disabled="${
                    (section=='intake'       and a.status.name()!='SUBMITTED') or
                    (section=='assessment'   and !(a.status.name()=='UNDER_REVIEW' or a.status.name()=='ASSESSED')) or
                    (section=='disbursement' and a.status.name()!='APPROVED')
                  }">Chuyển đến phòng kế bên</button>
        </form>

        <!-- 3) Từ chối (lý do) -->
        <form th:action="@{'/admin/' + ${a.id} + '/reject'}" method="post" style="display:inline;margin-left:6px">
          <input class="input" name="reason" placeholder="Lý do từ chối"
                 th:disabled="${a.status.name()=='DISBURSED'}" required/>
          <input type="hidden" name="redirectTo" th:value="@{'/admin/' + ${section}}"/>
          <button class="btn btn-danger" th:disabled="${a.status.name()=='DISBURSED'}">Từ chối</button>
        </form>
      </td>
    </tr>
    </tbody>
  </table>
</div>
</body>
</html>
