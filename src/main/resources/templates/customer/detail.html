<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <title>Chi tiết hồ sơ #[[${app.id}]]</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .customer-header {
            background: linear-gradient(135deg, #22d3ee, #0891b2);
            padding: 20px;
            border-radius: 12px;
            color: white;
            margin-bottom: 24px;
        }
        .status-timeline {
            background: #1f2937;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #374151;
        }
        .timeline-item {
            display: flex;
            align-items: flex-start;
            margin: 16px 0;
            padding: 12px 0;
            border-bottom: 1px solid #374151;
        }
        .timeline-item:last-child {
            border-bottom: none;
        }
        .timeline-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            flex-shrink: 0;
            font-size: 1.2em;
        }
        .timeline-icon.completed {
            background: #22c55e;
            color: white;
        }
        .timeline-icon.current {
            background: #22d3ee;
            color: #083344;
            animation: pulse 2s infinite;
        }
        .timeline-icon.pending {
            background: #374151;
            color: #9ca3af;
        }
        .timeline-icon.rejected {
            background: #ef4444;
            color: white;
        }
        .timeline-content {
            flex: 1;
        }
        .timeline-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .timeline-time {
            font-size: 0.9em;
            opacity: 0.7;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .info-card {
            background: #1f2937;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #374151;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 4px 0;
        }
        .info-label {
            color: #9ca3af;
            font-weight: 500;
        }
        .info-value {
            font-weight: 600;
            color: #e5e7eb;
        }
        @media (max-width: 768px) {
            .info-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Customer Header -->
    <div class="customer-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1 style="margin: 0;">📋 Hồ sơ vay #<span th:text="${app.id}"></span></h1>
                <p style="margin: 8px 0 0 0; opacity: 0.9;">
                    Trạng thái: <span class="badge" th:text="${app.status}" style="background: rgba(255,255,255,0.2); color: white;"></span>
                </p>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 1.5em; font-weight: bold;" th:text="${#numbers.formatInteger(app.amount, 3, 'POINT')}">0</div>
                <div style="opacity: 0.8; font-size: 0.9em;">VND</div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div style="margin-bottom: 20px;">
        <a href="/my-applications" class="btn btn-outline">← Về danh sách hồ sơ</a>
        <a th:if="${app.status.name() == 'APPROVED' or app.status.name() == 'DISBURSED'}"
           th:href="@{'/admin/' + ${app.id} + '/contract'}" class="btn btn-outline">📄 Xem hợp đồng</a>
    </div>

    <!-- Status Timeline -->
    <div class="status-timeline">
        <h3 style="margin: 0 0 20px 0;">🚀 Tiến trình xử lý hồ sơ</h3>

        <div class="timeline-item">
            <div class="timeline-icon completed">✓</div>
            <div class="timeline-content">
                <div class="timeline-title">Nộp hồ sơ</div>
                <div class="timeline-time" th:text="${#temporals.format(app.submittedAt, 'dd/MM/yyyy HH:mm')}"></div>
                <div style="font-size: 0.9em; opacity: 0.8; margin-top: 4px;">
                    Hồ sơ đã được nộp thành công vào hệ thống
                </div>
            </div>
        </div>

        <div class="timeline-item">
            <div th:class="'timeline-icon ' + (${app.status.name() == 'SUBMITTED'} ? 'current' : (${app.reviewedAt != null} ? 'completed' : 'pending'))">
                <span th:if="${app.reviewedAt != null}">✓</span>
                <span th:if="${app.reviewedAt == null and app.status.name() == 'SUBMITTED'}">⏳</span>
                <span th:if="${app.reviewedAt == null and app.status.name() != 'SUBMITTED'}">📋</span>
            </div>
            <div class="timeline-content">
                <div class="timeline-title">Phòng tiếp nhận xử lý</div>
                <div th:if="${app.reviewedAt}" class="timeline-time"
                     th:text="${#temporals.format(app.reviewedAt, 'dd/MM/yyyy HH:mm')}"></div>
                <div style="font-size: 0.9em; opacity: 0.8; margin-top: 4px;">
                    <span th:if="${app.reviewedAt != null}">Hồ sơ đã được tiếp nhận và chuyển sang thẩm định</span>
                    <span th:if="${app.reviewedAt == null and app.status.name() == 'SUBMITTED'}">Đang kiểm tra tính đầy đủ của hồ sơ</span>
                    <span th:if="${app.reviewedAt == null and app.status.name() != 'SUBMITTED'}">Chờ xử lý</span>
                </div>
            </div>
        </div>

        <div class="timeline-item">
            <div th:class="'timeline-icon ' + (${app.status.name() == 'UNDER_REVIEW'} ? 'current' : (${app.assessedAt != null} ? 'completed' : 'pending'))">
                <span th:if="${app.assessedAt != null}">✓</span>
                <span th:if="${app.assessedAt == null and app.status.name() == 'UNDER_REVIEW'}">🔍</span>
                <span th:if="${app.assessedAt == null and app.status.name() != 'UNDER_REVIEW'}">🔍</span>
            </div>
            <div class="timeline-content">
                <div class="timeline-title">Thẩm định tín dụng</div>
                <div th:if="${app.assessedAt}" class="timeline-time"
                     th:text="${#temporals.format(app.assessedAt, 'dd/MM/yyyy HH:mm')}"></div>
                <div style="font-size: 0.9em; opacity: 0.8; margin-top: 4px;">
                    <span th:if="${app.assessedAt != null}">Đã hoàn tất thẩm định, chờ quyết định phê duyệt</span>
                    <span th:if="${app.assessedAt == null and app.status.name() == 'UNDER_REVIEW'}">Đang thực hiện thẩm định tín dụng</span>
                    <span th:if="${app.assessedAt == null and app.status.name() != 'UNDER_REVIEW' and app.reviewedAt != null}">Chờ thẩm định</span>
                </div>
            </div>
        </div>

        <div class="timeline-item">
            <div th:class="'timeline-icon ' +
                (${app.status.name() == 'ASSESSED'} ? 'current' :
                (${app.approvedAt != null} ? 'completed' :
                (${app.rejectedAt != null} ? 'rejected' : 'pending')))">
                <span th:if="${app.approvedAt != null}">✓</span>
                <span th:if="${app.rejectedAt != null}">❌</span>
                <span th:if="${app.approvedAt == null and app.rejectedAt == null and app.status.name() == 'ASSESSED'}">⚖️</span>
                <span th:if="${app.approvedAt == null and app.rejectedAt == null and app.status.name() != 'ASSESSED'}">⚖️</span>
            </div>
            <div class="timeline-content">
                <div class="timeline-title">Quyết định phê duyệt</div>
                <div th:if="${app.approvedAt}" class="timeline-time"
                     th:text="${#temporals.format(app.approvedAt, 'dd/MM/yyyy HH:mm')}"></div>
                <div th:if="${app.rejectedAt}" class="timeline-time"
                     th:text="${#temporals.format(app.rejectedAt, 'dd/MM/yyyy HH:mm')}"></div>
                <div style="font-size: 0.9em; opacity: 0.8; margin-top: 4px;">
                    <span th:if="${app.approvedAt != null}">🎉 Hồ sơ đã được phê duyệt! Chờ giải ngân</span>
                    <span th:if="${app.rejectedAt != null}">❌ Hồ sơ đã bị từ chối</span>
                    <span th:if="${app.approvedAt == null and app.rejectedAt == null and app.status.name() == 'ASSESSED'}">Đang xem xét và đưa ra quyết định</span>
                    <span th:if="${app.approvedAt == null and app.rejectedAt == null and app.status.name() != 'ASSESSED' and app.assessedAt != null}">Chờ quyết định</span>
                </div>
            </div>
        </div>

        <div th:if="${app.status.name() != 'REJECTED'}" class="timeline-item">
            <div th:class="'timeline-icon ' + (${app.status.name() == 'APPROVED'} ? 'current' : (${app.disbursedAt != null} ? 'completed' : 'pending'))">
                <span th:if="${app.disbursedAt != null}">✓</span>
                <span th:if="${app.disbursedAt == null and app.status.name() == 'APPROVED'}">💰</span>
                <span th:if="${app.disbursedAt == null and app.status.name() != 'APPROVED'}">💰</span>
            </div>
            <div class="timeline-content">
                <div class="timeline-title">Giải ngân</div>
                <div th:if="${app.disbursedAt}" class="timeline-time"
                     th:text="${#temporals.format(app.disbursedAt, 'dd/MM/yyyy HH:mm')}"></div>
                <div style="font-size: 0.9em; opacity: 0.8; margin-top: 4px;">
                    <span th:if="${app.disbursedAt != null}">✨ Khoản vay đã được giải ngân thành công!</span>
                    <span th:if="${app.disbursedAt == null and app.status.name() == 'APPROVED'}">Đang thực hiện thủ tục giải ngân</span>
                    <span th:if="${app.disbursedAt == null and app.status.name() != 'APPROVED'}">Chờ giải ngân</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Application Details -->
    <div class="info-grid">
        <div class="info-card">
            <h3 style="margin: 0 0 16px 0;">👤 Thông tin cá nhân</h3>
            <div class="info-row">
                <span class="info-label">Họ tên:</span>
                <span class="info-value" th:text="${app.customer.fullName}"></span>
            </div>
            <div class="info-row">
                <span class="info-label">Email:</span>
                <span class="info-value" th:text="${app.customer.email}"></span>
            </div>
            <div class="info-row">
                <span class="info-label">Điện thoại:</span>
                <span class="info-value" th:text="${app.customer.phone}"></span>
            </div>
            <div class="info-row">
                <span class="info-label">Thu nhập/tháng:</span>
                <span class="info-value" th:text="${#numbers.formatInteger(app.monthlyIncome, 3, 'POINT')} + ' VND'"></span>
            </div>
        </div>

        <div class="info-card">
            <h3 style="margin: 0 0 16px 0;">💰 Thông tin khoản vay</h3>
            <div class="info-row">
                <span class="info-label">Số tiền:</span>
                <span class="info-value" style="color: #22d3ee;" th:text="${#numbers.formatInteger(app.amount, 3, 'POINT')} + ' VND'"></span>
            </div>
            <div class="info-row">
                <span class="info-label">Thời hạn:</span>
                <span class="info-value" th:text="${app.termMonths} + ' tháng'"></span>
            </div>
            <div class="info-row">
                <span class="info-label">Mục đích:</span>
                <span class="info-value" th:text="${app.purpose != null ? app.purpose : 'Không xác định'}"></span>
            </div>
            <div class="info-row">
                <span class="info-label">Ngày nộp:</span>
                <span class="info-value" th:text="${#temporals.format(app.submittedAt, 'dd/MM/yyyy')}"></span>
            </div>
        </div>
    </div>

    <!-- Additional Information -->
    <div th:if="${app.assessmentNote != null or app.approvalNote != null or app.rejectionReason != null}">
        <div class="info-card">
            <h3 style="margin: 0 0 16px 0;">📝 Ghi chú từ ngân hàng</h3>

            <div th:if="${app.assessmentNote != null}" style="margin: 12px 0; padding: 12px; background: #0f172a; border-radius: 6px; border-left: 4px solid #22d3ee;">
                <strong style="color: #22d3ee;">Kết quả thẩm định:</strong>
                <p style="margin: 8px 0 0 0;" th:text="${app.assessmentNote}"></p>
            </div>

            <div th:if="${app.approvalNote != null}" style="margin: 12px 0; padding: 12px; background: rgba(34, 197, 94, 0.1); border-radius: 6px; border-left: 4px solid #22c55e;">
                <strong style="color: #22c55e;">Ghi chú phê duyệt:</strong>
                <p style="margin: 8px 0 0 0;" th:text="${app.approvalNote}"></p>
            </div>

            <div th:if="${app.rejectionReason != null}" style="margin: 12px 0; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; border-left: 4px solid #ef4444;">
                <strong style="color: #ef4444;">Lý do từ chối:</strong>
                <p style="margin: 8px 0 0 0;" th:text="${app.rejectionReason}"></p>
            </div>
        </div>
    </div>

    <!-- Action buttons -->
    <div style="margin-top: 30px; text-align: center;">
        <div th:if="${app.status.name() == 'SUBMITTED' or app.status.name() == 'UNDER_REVIEW'}">
            <div style="padding: 16px; background: rgba(34, 211, 238, 0.1); border-radius: 8px; border: 1px solid #22d3ee; margin-bottom: 16px;">
                <h4 style="margin: 0 0 8px 0; color: #22d3ee;">⏳ Hồ sơ đang được xử lý</h4>
                <p style="margin: 0; opacity: 0.8;">
                    Ngân hàng sẽ liên hệ với bạn trong vòng 1-3 ngày làm việc.
                    Vui lòng kiểm tra email và điện thoại thường xuyên.
                </p>
            </div>
        </div>

        <div th:if="${app.status.name() == 'APPROVED'}">
            <div style="padding: 16px; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border: 1px solid #22c55e; margin-bottom: 16px;">
                <h4 style="margin: 0 0 8px 0; color: #22c55e;">🎉 Chúc mừng! Hồ sơ đã được phê duyệt</h4>
                <p style="margin: 0; opacity: 0.8;">
                    Ngân hàng sẽ liên hệ để hoàn tất thủ tục giải ngân.
                    Vui lòng chuẩn bị các giấy tờ cần thiết.
                </p>
            </div>
        </div>

        <div th:if="${app.status.name() == 'DISBURSED'}">
            <div style="padding: 16px; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border: 1px solid #16a34a; margin-bottom: 16px;">
                <h4 style="margin: 0 0 8px 0; color: #16a34a;">✨ Hoàn tất! Khoản vay đã được giải ngân</h4>
                <p style="margin: 0; opacity: 0.8;">
                    Cảm ơn bạn đã tin tưởng dịch vụ của chúng tôi.
                    Vui lòng kiểm tra tài khoản và liên hệ nếu có thắc mắc.
                </p>
            </div>
        </div>

        <a href="/my-applications" class="btn btn-primary">← Về danh sách hồ sơ</a>
        <a href="/apply" class="btn btn-outline">📝 Nộp hồ sơ mới</a>
    </div>

    <!-- Help section -->
    <div style="margin-top: 40px; padding: 20px; background: #0f172a; border-radius: 12px; border: 1px solid #374151;">
        <h4>❓ Cần hỗ trợ về hồ sơ này?</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 16px;">
            <div>
                <strong>📞 Hotline:</strong><br>
                <span style="color: #22d3ee;">1900-123-456</span><br>
                <small style="opacity: 0.7;">Nhắc mã hồ sơ #<span th:text="${app.id}"></span></small>
            </div>
            <div>
                <strong>📧 Email:</strong><br>
                <span style="color: #22d3ee;">support@bank.com</span>
            </div>
            <div>
                <strong>🏢 Chi nhánh:</strong><br>
                <span>Tìm chi nhánh gần nhất</span>
            </div>
        </div>
    </div>
</div>

<script>
// Auto refresh every 30 seconds to check for status updates
setTimeout(() => location.reload(), 30000);
</script>
</body>
</html>